# ui.py
from PyQt5.QtWidgets import (QWidget, QLabel, QVBoxLayout, QGridLayout, QFrame, 
                             QHBoxLayout, QLineEdit, QComboBox, QPushButton, 
                             QScrollArea, QStackedWidget, QCheckBox, QApplication)
from PyQt5.QtCore import Qt, pyqtSignal
from PyQt5.QtGui import QFont, QCursor
# YENƒ∞: get_garage_stats ve load_garage eklendi
from database import get_smart_badges, parse_number, load_garage, get_garage_stats
from workers import ImageLoaderThread

# ==========================================
# 1. KART TASARIMI (SENƒ∞N KODUN - DOKUNULMADI)
# ==========================================
class VehicleCard(QFrame):
    clicked = pyqtSignal(dict)
    
    def __init__(self, vehicle_data):
        super().__init__()
        self.vehicle_data = vehicle_data
        self.setFixedSize(290, 320)
        self.setAttribute(Qt.WA_StyledBackground, True)
        self.setStyleSheet("""
            VehicleCard { background-color: rgba(30, 30, 30, 180); border-radius: 12px; border: 2px solid #333; }
            VehicleCard:hover { background-color: rgba(45, 45, 45, 240); border: 2px solid #00FF96; }
        """)
        self.setCursor(QCursor(Qt.PointingHandCursor))
        
        layout = QVBoxLayout()
        layout.setContentsMargins(15, 15, 15, 15)
        self.setLayout(layout)
        
        self.img_label = QLabel()
        self.img_label.setFixedSize(260, 145)
        self.img_label.setStyleSheet("border: none; background: transparent;")
        self.img_label.setAlignment(Qt.AlignCenter)
        layout.addWidget(self.img_label)
        
        name = vehicle_data.get("Vehicle Name", "Bilinmiyor")
        v_class = vehicle_data.get("Vehicle Class", "")
        
        self.name_label = QLabel(f"<center><span style='color: #00FF96; font-size: 13pt; font-weight: bold;'>{name}</span><br><span style='color: #AAAAAA; font-size: 10pt;'>{v_class}</span></center>")
        self.name_label.setStyleSheet("border: none; background: transparent;")
        self.name_label.setWordWrap(True)
        self.name_label.setAlignment(Qt.AlignCenter)
        layout.addWidget(self.name_label)
        
        layout.addStretch() 
        
        badges = get_smart_badges(vehicle_data)
        badge_layout = QHBoxLayout()
        badge_layout.setAlignment(Qt.AlignCenter)
        for text, color in badges[:2]:
            b = QLabel(text)
            b.setFont(QFont("Segoe UI", 8, QFont.Bold))
            b.setStyleSheet(f"background-color: {color}; color: white; border-radius: 4px; padding: 4px 8px; border: none;")
            badge_layout.addWidget(b)
        layout.addLayout(badge_layout)

    def set_image(self, pixmap):
        try: self.img_label.setPixmap(pixmap.scaled(260, 145, Qt.KeepAspectRatio, Qt.SmoothTransformation))
        except RuntimeError: pass

    def mousePressEvent(self, event):
        if event.button() == Qt.LeftButton: self.clicked.emit(self.vehicle_data)

# ==========================================
# 2. GALERƒ∞ PENCERESƒ∞ (G√úNCELLENDƒ∞: SEKMELER + ƒ∞STATƒ∞STƒ∞K)
# ==========================================
class GalleryWindow(QWidget):
    def __init__(self, db_data, image_cache):
        super().__init__()
        self.db_data = db_data
        self.filtered_data = db_data
        self.image_cache = image_cache
        self.items_per_page = 15
        self.current_page = 0
        self.threads = []
        
        # YENƒ∞: Varsayƒ±lan sekme
        self.current_tab = "STORE" 
        
        self.all_classes = sorted(list(set(c.get("Vehicle Class", "") for c in db_data if c.get("Vehicle Class", ""))))
        self.all_manufacturers = sorted(list(set(c.get("Manufacturer", "") for c in db_data if c.get("Manufacturer", ""))))
        self.all_vendors = sorted(list(set(c.get("Acquisition", "") for c in db_data if c.get("Acquisition", ""))))
        
        self.setWindowFlags(Qt.FramelessWindowHint | Qt.WindowStaysOnTopHint)
        self.setAttribute(Qt.WA_TranslucentBackground)
        self.setFixedSize(1602, 1315) 
        
        screen = QApplication.desktop().screenGeometry()
        self.move((screen.width() - self.width()) // 2, (screen.height() - self.height()) // 2)

        self.main_layout = QVBoxLayout()
        self.main_layout.setContentsMargins(0, 0, 0, 0)
        self.setLayout(self.main_layout)

        self.bg_frame = QFrame()
        self.bg_frame.setStyleSheet("""
            QFrame { background-color: rgba(18, 18, 18, 250); border: 2px solid #00FF96; border-radius: 15px; }
            QLineEdit { background: #2b2b2b; color: #FFF; padding: 10px 15px; border-radius: 6px; border: 1px solid #444; font-size: 11pt; font-weight: bold; }
            QLineEdit:focus { border: 1px solid #00FF96; }
            QComboBox { background: #2b2b2b; color: #FFF; padding: 10px 15px; border-radius: 6px; border: 1px solid #444; font-size: 11pt; font-weight: bold; }
            QComboBox:focus { border: 1px solid #00FF96; }
            QComboBox::drop-down { border: 0px; }
            QCheckBox { color: #FFF; font-weight: bold; font-size: 11pt; }
            QScrollBar:vertical { background: #1a1a1a; width: 12px; margin: 0px; border-radius: 6px;}
            QScrollBar::handle:vertical { background: #00FF96; min-height: 20px; border-radius: 6px;}
            QScrollBar::add-line:vertical, QScrollBar::sub-line:vertical { height: 0px; }
        """)
        self.bg_layout = QVBoxLayout(self.bg_frame)
        self.bg_layout.setContentsMargins(25, 25, 25, 25)
        self.main_layout.addWidget(self.bg_frame)

        self.stacked_widget = QStackedWidget()
        self.bg_layout.addWidget(self.stacked_widget)

        self.setup_gallery_page()
        self.setup_detail_page()
        
        # YENƒ∞: Ba≈ülangƒ±√ß ayarlarƒ±
        self.update_tab_buttons()
        self.apply_filters() 

    def keyPressEvent(self, event):
        if event.key() == Qt.Key_Escape: self.hide()
        else: super().keyPressEvent(event)

    # YENƒ∞: Sekme Deƒüi≈ütirme
    def switch_tab(self, mode):
        self.current_tab = mode
        self.update_tab_buttons()
        
        if mode == "GARAGE":
            count, value = get_garage_stats(self.db_data)
            self.stats_label.setText(f"üí∞ TOPLAM GARAJ DEƒûERƒ∞: <span style='color:#fdcb6e;'>{value}</span> &nbsp;&nbsp;|&nbsp;&nbsp; üèéÔ∏è ARA√á SAYISI: <span style='color:#00FF96;'>{count}</span>")
            self.stats_label.show()
        else:
            self.stats_label.hide()
            
        self.apply_filters()

    # YENƒ∞: Buton Renklerini G√ºncelleme
    def update_tab_buttons(self):
        active_style = "background: #00FF96; color: black; font-weight: bold; padding: 10px; border-radius: 6px; font-size: 11pt;"
        passive_style = "background: #2b2b2b; color: white; font-weight: bold; padding: 10px; border-radius: 6px; font-size: 11pt; border: 1px solid #444;"
        
        if self.current_tab == "STORE":
            self.btn_store.setStyleSheet(active_style)
            self.btn_garage.setStyleSheet(passive_style)
        else:
            self.btn_store.setStyleSheet(passive_style)
            self.btn_garage.setStyleSheet(active_style)

    def setup_gallery_page(self):
        page = QWidget()
        layout = QVBoxLayout(page)
        layout.setContentsMargins(0, 0, 0, 0)
        
        # --- YENƒ∞: Sekme Butonlarƒ± ---
        tabs_layout = QHBoxLayout()
        tabs_layout.setSpacing(15)
        
        self.btn_store = QPushButton("üõí MAƒûAZA (T√úM ARA√áLAR)")
        self.btn_store.setCursor(QCursor(Qt.PointingHandCursor))
        self.btn_store.clicked.connect(lambda: self.switch_tab("STORE"))
        tabs_layout.addWidget(self.btn_store)
        
        self.btn_garage = QPushButton("üè† GARAJIM")
        self.btn_garage.setCursor(QCursor(Qt.PointingHandCursor))
        self.btn_garage.clicked.connect(lambda: self.switch_tab("GARAGE"))
        tabs_layout.addWidget(self.btn_garage)
        
        layout.addLayout(tabs_layout)
        # -----------------------------

        # --- YENƒ∞: ƒ∞statistik Barƒ± ---
        self.stats_label = QLabel("Y√ºkleniyor...")
        self.stats_label.setAlignment(Qt.AlignCenter)
        self.stats_label.setStyleSheet("""
            background-color: #2d3436; 
            color: white; 
            font-size: 12pt; 
            font-weight: bold; 
            padding: 8px; 
            border-radius: 6px; 
            border: 1px solid #636e72;
            margin-top: 5px;
            margin-bottom: 5px;
        """)
        self.stats_label.hide()
        layout.addWidget(self.stats_label)
        # -----------------------------
        
        top_bar_1 = QHBoxLayout()
        top_bar_1.setSpacing(15)
        self.search_box = QLineEdit()
        self.search_box.setPlaceholderText("Ara√ß Ara (√ñrn: Zentorno, T20)...")
        self.search_box.textChanged.connect(self.apply_filters)
        top_bar_1.addWidget(self.search_box, stretch=2)
        self.sort_box = QComboBox()
        self.sort_box.addItems(["Sƒ±ralama: Varsayƒ±lan", "Fiyat: √ñnce En Pahalƒ±", "Fiyat: √ñnce En Ucuz", "Hƒ±z: En Hƒ±zlƒ±lar", "ƒ∞vme: En Y√ºksek Kalkƒ±≈ü"])
        self.sort_box.currentTextChanged.connect(self.apply_filters)
        top_bar_1.addWidget(self.sort_box, stretch=1)
        close_btn = QPushButton("KAPAT (F11)")
        close_btn.setCursor(QCursor(Qt.PointingHandCursor))
        close_btn.setStyleSheet("background: #d63031; color: white; padding: 10px 20px; border-radius: 6px; font-weight:bold; font-size: 11pt;")
        close_btn.clicked.connect(self.hide)
        top_bar_1.addWidget(close_btn)
        layout.addLayout(top_bar_1)
        
        top_bar_2 = QHBoxLayout()
        top_bar_2.setSpacing(15)
        self.class_box = QComboBox()
        self.class_box.addItem("T√ºm Sƒ±nƒ±flar")
        self.class_box.addItems(self.all_classes)
        self.class_box.currentTextChanged.connect(self.apply_filters)
        top_bar_2.addWidget(self.class_box)
        self.brand_box = QComboBox()
        self.brand_box.addItem("T√ºm Markalar")
        self.brand_box.addItems(self.all_manufacturers)
        self.brand_box.currentTextChanged.connect(self.apply_filters)
        top_bar_2.addWidget(self.brand_box)
        self.vendor_box = QComboBox()
        self.vendor_box.addItem("T√ºm Satƒ±cƒ±lar")
        self.vendor_box.addItems(self.all_vendors)
        self.vendor_box.currentTextChanged.connect(self.apply_filters)
        top_bar_2.addWidget(self.vendor_box)
        self.armor_check = QCheckBox("Sadece Zƒ±rhlƒ±")
        self.armor_check.setCursor(QCursor(Qt.PointingHandCursor))
        self.armor_check.stateChanged.connect(self.apply_filters)
        top_bar_2.addWidget(self.armor_check)
        self.weapon_check = QCheckBox("Sadece Silahlƒ±")
        self.weapon_check.setCursor(QCursor(Qt.PointingHandCursor))
        self.weapon_check.stateChanged.connect(self.apply_filters)
        top_bar_2.addWidget(self.weapon_check)
        layout.addLayout(top_bar_2)
        
        self.gallery_scroll = QScrollArea()
        self.gallery_scroll.setWidgetResizable(True)
        self.gallery_scroll.setStyleSheet("background: transparent; border: none;")
        self.grid_widget = QWidget()
        self.grid_widget.setStyleSheet("background: transparent;")
        self.grid_layout = QGridLayout(self.grid_widget)
        self.grid_layout.setSpacing(15) 
        self.grid_layout.setAlignment(Qt.AlignTop)
        self.gallery_scroll.setWidget(self.grid_widget)
        layout.addWidget(self.gallery_scroll)
        
        bottom_bar = QHBoxLayout()
        self.prev_btn = QPushButton("<< √ñNCEKƒ∞ SAYFA")
        self.prev_btn.setCursor(QCursor(Qt.PointingHandCursor))
        self.prev_btn.setStyleSheet("background: #2b2b2b; color: white; padding: 10px 20px; border-radius: 6px; font-weight:bold; font-size: 11pt;")
        self.prev_btn.clicked.connect(lambda: self.change_page(-1))
        bottom_bar.addWidget(self.prev_btn)
        self.page_label = QLabel("Sayfa 1 / 1")
        self.page_label.setStyleSheet("color: #00FF96; font-weight: bold; font-size: 14pt;")
        self.page_label.setAlignment(Qt.AlignCenter)
        bottom_bar.addWidget(self.page_label)
        self.next_btn = QPushButton("SONRAKƒ∞ SAYFA >>")
        self.next_btn.setCursor(QCursor(Qt.PointingHandCursor))
        self.next_btn.setStyleSheet("background: #00FF96; color: black; padding: 10px 20px; border-radius: 6px; font-weight:bold; font-size: 11pt;")
        self.next_btn.clicked.connect(lambda: self.change_page(1))
        bottom_bar.addWidget(self.next_btn)
        layout.addLayout(bottom_bar)
        self.stacked_widget.addWidget(page)

    def setup_detail_page(self):
        page = QWidget()
        layout = QVBoxLayout(page)
        top_bar = QHBoxLayout()
        back_btn = QPushButton("<< GALERƒ∞YE D√ñN")
        back_btn.setCursor(QCursor(Qt.PointingHandCursor))
        back_btn.setStyleSheet("background: #00FF96; color: black; font-weight: bold; padding: 10px 20px; border-radius: 6px; font-size: 11pt;")
        back_btn.clicked.connect(lambda: self.stacked_widget.setCurrentIndex(0))
        top_bar.addWidget(back_btn)
        top_bar.addStretch()
        layout.addLayout(top_bar)
        self.detail_scroll = QScrollArea()
        self.detail_scroll.setWidgetResizable(True)
        self.detail_scroll.setStyleSheet("background: transparent; border: none;")
        self.detail_content = QWidget()
        self.detail_layout = QVBoxLayout(self.detail_content)
        self.detail_title = QLabel()
        self.detail_title.setAlignment(Qt.AlignCenter)
        self.detail_layout.addWidget(self.detail_title)
        self.detail_img = QLabel()
        self.detail_img.setAlignment(Qt.AlignCenter)
        self.detail_layout.addWidget(self.detail_img)
        self.detail_badges = QHBoxLayout()
        self.detail_badges.setAlignment(Qt.AlignCenter)
        self.detail_layout.addLayout(self.detail_badges)
        self.detail_stats = QGridLayout()
        self.detail_stats.setSpacing(10)
        self.detail_layout.addLayout(self.detail_stats)
        self.detail_scroll.setWidget(self.detail_content)
        layout.addWidget(self.detail_scroll)
        self.stacked_widget.addWidget(page)

    def apply_filters(self):
        query = self.search_box.text().lower()
        v_class = self.class_box.currentText()
        brand = self.brand_box.currentText()
        vendor = self.vendor_box.currentText()
        req_armor = self.armor_check.isChecked()
        req_weapon = self.weapon_check.isChecked()
        sort_mode = self.sort_box.currentText()
        
        # YENƒ∞: Garaj listesini √ßek
        owned_list = load_garage()
        
        self.filtered_data = []
        for car in self.db_data:
            # YENƒ∞: Garaj modundaysa sadece sahip olunanlarƒ± g√∂ster
            if self.current_tab == "GARAGE":
                if car.get("Vehicle Name") not in owned_list:
                    continue
            
            match_query = query in car.get("Vehicle Name", "").lower()
            match_class = (v_class == "T√ºm Sƒ±nƒ±flar") or (v_class == car.get("Vehicle Class", ""))
            match_brand = (brand == "T√ºm Markalar") or (brand == car.get("Manufacturer", ""))
            match_vendor = (vendor == "T√ºm Satƒ±cƒ±lar") or (vendor == car.get("Acquisition", ""))
            match_armor = True
            if req_armor: match_armor = "Yes" in str(car.get("Bulletproof", ""))
            match_weapon = True
            if req_weapon: match_weapon = "Weaponized" in str(car.get("Vehicle Features", ""))
            if match_query and match_class and match_brand and match_vendor and match_armor and match_weapon:
                self.filtered_data.append(car)
        
        if sort_mode == "Fiyat: √ñnce En Pahalƒ±":
            self.filtered_data.sort(key=lambda x: parse_number(x.get("GTA Online Price", "0")), reverse=True)
        elif sort_mode == "Fiyat: √ñnce En Ucuz":
            self.filtered_data.sort(key=lambda x: parse_number(x.get("GTA Online Price", "0")))
        elif sort_mode == "Hƒ±z: En Hƒ±zlƒ±lar":
            self.filtered_data.sort(key=lambda x: parse_number(x.get("Top Speed (Broughy)", "0")), reverse=True)
        elif sort_mode == "ƒ∞vme: En Y√ºksek Kalkƒ±≈ü":
            self.filtered_data.sort(key=lambda x: parse_number(x.get("Stat - Acceleration", "0")), reverse=True)
        
        self.current_page = 0
        self.load_page()

    def load_page(self):
        self.threads = [t for t in self.threads if t.isRunning()]
        for i in reversed(range(self.grid_layout.count())): 
            w = self.grid_layout.itemAt(i).widget()
            if w: w.deleteLater()
        total_pages = max(1, (len(self.filtered_data) + self.items_per_page - 1) // self.items_per_page)
        self.page_label.setText(f"Sayfa {self.current_page + 1} / {total_pages}")
        self.prev_btn.setEnabled(self.current_page > 0)
        self.next_btn.setEnabled(self.current_page < total_pages - 1)
        start_idx = self.current_page * self.items_per_page
        end_idx = start_idx + self.items_per_page
        page_items = self.filtered_data[start_idx:end_idx]
        row, col = 0, 0
        for car in page_items:
            card = VehicleCard(car)
            card.clicked.connect(self.show_detail)
            self.grid_layout.addWidget(card, row, col)
            url = car.get("Image URL", "")
            if url in self.image_cache:
                card.set_image(self.image_cache[url])
            elif url and url != "Resim Bulunamadƒ±":
                thread = ImageLoaderThread(url)
                thread.image_loaded_signal.connect(lambda u, p, c=card: self.cache_and_set(u, p, c))
                self.threads.append(thread)
                thread.start()
            col += 1
            if col > 4: 
                col = 0
                row += 1

    def cache_and_set(self, url, pixmap, card):
        self.image_cache[url] = pixmap
        try: card.set_image(pixmap)
        except RuntimeError: pass

    def change_page(self, delta):
        self.current_page += delta
        self.load_page()

    def show_detail(self, vehicle_data):
        self.stacked_widget.setCurrentIndex(1)
        name = vehicle_data.get("Vehicle Name", "")
        v_class = vehicle_data.get("Vehicle Class", "")
        self.detail_title.setText(f"<span style='font-size:24pt; color:#00FF96; font-weight:bold;'>{name.upper()}</span><br><span style='color:#AAA; font-size:14pt;'>{v_class}</span>")
        url = vehicle_data.get("Image URL", "")
        self.detail_img.clear()
        if url in self.image_cache:
            self.detail_img.setPixmap(self.image_cache[url].scaled(600, 350, Qt.KeepAspectRatio, Qt.SmoothTransformation))
        for i in reversed(range(self.detail_badges.count())): 
            w = self.detail_badges.itemAt(i).widget()
            if w: w.deleteLater()
        for text, color in get_smart_badges(vehicle_data):
            b = QLabel(text)
            b.setFont(QFont("Segoe UI", 12, QFont.Bold))
            b.setStyleSheet(f"background-color: {color}; color: white; border-radius: 6px; padding: 6px 15px; margin: 10px;")
            self.detail_badges.addWidget(b)
        for i in reversed(range(self.detail_stats.count())): 
            w = self.detail_stats.itemAt(i).widget()
            if w: w.deleteLater()
        row = 0
        exclude_keys = ["Vehicle Name", "Vehicle Class", "Link", "Image URL"]
        for key, value in vehicle_data.items():
            if key not in exclude_keys and value and value != "Veri Yok":
                lbl_title = QLabel(f"{key}:")
                lbl_title.setFont(QFont("Segoe UI", 12, QFont.Bold)) 
                lbl_title.setStyleSheet("color: #AAAAAA; padding: 5px;")
                lbl_value = QLabel(str(value))
                lbl_value.setFont(QFont("Segoe UI", 12)) 
                lbl_value.setStyleSheet("color: #FFFFFF; padding: 5px;")
                lbl_value.setWordWrap(True)
                self.detail_stats.addWidget(lbl_title, row, 0)
                self.detail_stats.addWidget(lbl_value, row, 1)
                row += 1

# ==========================================
# 3. HUD ARAY√úZ√ú (SENƒ∞N "M√úKEMMEL √áALI≈ûAN" KODUN - Hƒ∞√á DOKUNULMADI!)
# ==========================================
class OverlayHUD(QWidget):
    def __init__(self, image_cache):
        super().__init__()
        self.image_cache = image_cache
        self.current_img_url = "" 
        
        self.setWindowFlags(Qt.FramelessWindowHint | Qt.WindowStaysOnTopHint | 
                            Qt.WindowTransparentForInput | Qt.Tool | Qt.WindowDoesNotAcceptFocus)
        self.setAttribute(Qt.WA_TranslucentBackground)
        self.setAttribute(Qt.WA_ShowWithoutActivating)

        self.setMinimumWidth(430)
        self.setMaximumWidth(600) 
        self.fixed_y = 40

        self.layout = QVBoxLayout()
        self.layout.setContentsMargins(5, 5, 5, 5)
        self.layout.setSizeConstraint(QVBoxLayout.SetFixedSize)
        self.setLayout(self.layout)

        self.frame = QFrame(self)
        self.frame.setStyleSheet("background-color: rgba(15, 15, 15, 215); border: 2px solid rgba(0, 255, 150, 150); border-radius: 8px;")
        
        self.frame_layout = QVBoxLayout(self.frame)
        self.layout.addWidget(self.frame)

        self.title_label = QLabel()
        self.title_label.setAlignment(Qt.AlignCenter)
        self.frame_layout.addWidget(self.title_label)

        self.image_label = QLabel()
        self.image_label.setAlignment(Qt.AlignCenter)
        self.frame_layout.addWidget(self.image_label)

        self.badges_layout = QHBoxLayout()
        self.badges_layout.setAlignment(Qt.AlignCenter)
        self.frame_layout.addLayout(self.badges_layout)

        self.grid_layout = QGridLayout()
        self.frame_layout.addLayout(self.grid_layout)

    def resizeEvent(self, event):
        screen_width = QApplication.desktop().screenGeometry().width()
        self.move(screen_width - self.width() - 20, self.fixed_y)
        super().resizeEvent(event)

    def update_ui(self, vehicle_data):
        if not self.isVisible():
            self.show()
            
        name = vehicle_data.get("Vehicle Name", "")
        v_class = vehicle_data.get("Vehicle Class", "")
        self.title_label.setText(f"<center><span style='font-size:16pt; color:#00FF96; font-weight:bold;'>{name.upper()}</span><br><span style='font-size:12pt; color:#AAAAAA;'>{v_class}</span></center>")
        self.image_label.clear()
        
        for i in reversed(range(self.badges_layout.count())): 
            w = self.badges_layout.itemAt(i).widget()
            if w: w.deleteLater()
            
        for text, color in get_smart_badges(vehicle_data):
            b = QLabel(text)
            b.setFont(QFont("Segoe UI", 8, QFont.Bold))
            b.setStyleSheet(f"background-color: {color}; color: white; border-radius: 4px; padding: 3px 6px;")
            self.badges_layout.addWidget(b)

        img_url = vehicle_data.get("Image URL", "")
        self.current_img_url = img_url 
        if img_url in self.image_cache:
            self.set_image(img_url, self.image_cache[img_url])
        elif img_url and img_url != "Resim Bulunamadƒ±":
            self.img_thread = ImageLoaderThread(img_url)
            self.img_thread.image_loaded_signal.connect(self.set_image)
            self.img_thread.start()

        for i in reversed(range(self.grid_layout.count())): 
            w = self.grid_layout.itemAt(i).widget()
            if w: w.deleteLater()

        row = 0
        exclude_keys = ["Vehicle Name", "Vehicle Class", "Link", "Image URL"]
        for key, value in vehicle_data.items():
            if key not in exclude_keys and value and value != "Veri Yok":
                lbl_title = QLabel(f"{key}:")
                lbl_title.setFont(QFont("Segoe UI", 10, QFont.Bold)) 
                lbl_title.setStyleSheet("color: #AAAAAA;")
                lbl_value = QLabel(str(value))
                lbl_value.setStyleSheet("color: #FFFFFF;")
                self.grid_layout.addWidget(lbl_title, row, 0)
                self.grid_layout.addWidget(lbl_value, row, 1)
                row += 1

    def set_image(self, url, pixmap):
        if pixmap is None or pixmap.isNull(): return
        self.image_cache[url] = pixmap
        if self.current_img_url == url:
            self.image_label.setPixmap(pixmap.scaled(self.width() - 30, 180, Qt.KeepAspectRatio, Qt.SmoothTransformation))